#!/bin/bash


set -e

echo "Starting deployment process for AI SaaS application..."


echo "Installing prerequisites: Docker, Kubernetes, Minikube..."
sudo apt-get update && sudo apt-get install -y \
    curl \
    wget \
    apt-transport-https \
    ca-certificates \
    software-properties-common


if ! command -v docker &> /dev/null; then
    echo "Installing Docker..."
    sudo apt-get remove -y docker docker-engine docker.io containerd runc || true
    sudo apt-get install -y docker.io
    sudo systemctl start docker
    sudo systemctl enable docker
else
    echo "Docker already installed."
fi


sudo usermod -aG docker $USER

<!-- Install kubectl -->
if ! command -v kubectl &> /dev/null; then
    echo "Installing kubectl..."
    sudo curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
    sudo install kubectl /usr/local/bin/kubectl
else
    echo "kubectl already installed."
fi


if ! command -v minikube &> /dev/null; then
    echo "Installing Minikube..."
    curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
    sudo install minikube-linux-amd64 /usr/local/bin/minikube
else
    echo "Minikube already installed."
fi


echo "Starting Minikube..."
minikube start --cpus=4 --memory=8g --driver=none


echo "Building Docker images for yolo-service and mlflow-service..."
eval $(minikube -p minikube docker-env) # Point Docker CLI to Minikube's Docker daemon


docker build -t yolo-service:latest ./yolo-service


docker build -t mlflow-service:latest ./mlflow-service


echo "Deploying Kubernetes resources..."


kubectl apply -f ./k8s/namespace.yaml


kubectl apply -f ./k8s/mongodb/mongodb-statefulset.yaml
kubectl apply -f ./k8s/mongodb/mongodb-service.yaml


kubectl apply -f ./k8s/mlflow/mlflow-deployment.yaml
kubectl apply -f ./k8s/mlflow/mlflow-service.yaml

kubectl apply -f ./k8s/yolo/yolo-deployment.yaml
kubectl apply -f ./k8s/yolo/yolo-service.yaml


kubectl apply -f ./k8s/ingress/ingress.yaml || echo "Ingress not configured. Skipping."


echo "Verifying deployment..."


kubectl wait --for=condition=ready pod --all -n ai-saas --timeout=300s


kubectl get all -n ai-saas


MINIKUBE_IP=$(minikube ip)
echo "Minikube is running at $MINIKUBE_IP"


echo "Application deployed successfully!"
echo "YOLO Service: http://$MINIKUBE_IP:8000"
echo "MLFlow Service: http://$MINIKUBE_IP:8001"
echo "MongoDB is running internally within the Kubernetes cluster."

exit 0
